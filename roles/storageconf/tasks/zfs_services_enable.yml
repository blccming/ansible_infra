---
- name: Copy ZFS mount service file
  template:
    src: "{{ role_path }}/templates/mount_zfs_pools.service"
    dest: "/etc/systemd/system/mount_zfs_pools.service"
    owner: root
    group: root
    mode: "0644"

- name: Enable ZFS mount service
  systemd:
    name: mount_zfs_pools.service
    state: started
    enabled: yes

- name: Copy ZFS backup script to bin directory
  template:
    src: "{{ role_path }}/templates/zfs_backup.sh"
    dest: "/usr/local/sbin/zfs_backup.sh"
    owner: root
    group: root
    mode: "0700"

- name: Create ZFS backup cron job
  cron:
    name: "Periodically backup zfs nas pool to backup pool (every day at 11:00)"
    minute: "0"
    hour: "11"
    job: "/usr/local/sbin/zfs_backup.sh"
    state: present

- name: Reboot if user confirms
  block:
    - name: Ask for confirmation before rebooting
      pause:
        prompt: "Do you want to reboot the system to enable ZFS services? (y/n)"
      register: reboot_confirmation

    - name: Reboot the system
      reboot:
        msg: "Rebooting to enable ZFS services"
      when: reboot_confirmation.user_input | lower == 'y'

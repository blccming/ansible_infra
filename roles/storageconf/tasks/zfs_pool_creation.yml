---
- name: Gather disk information
  command: lsblk -o WWN,NAME -n
  register: disk_info
  changed_when: false

- name: Set disk WWNs and device names as facts
  set_fact:
    disk_mapping: "{{ disk_info.stdout_lines | map('split') | map('list') | map('combine', {'wwn': item[0], 'device': '/dev/' + item[1]}) | list }}"

# Formatting user confirmation
- name: Ask for formatting permission
  pause:
    prompt: "WARNING: DATA LOSS.\n Do you want to format the following disks with ZFS (y/n)? Change in group vars, if needed.\n{{ disk_config }}"
  register: allow_formatting_user_input

- name: Set formatting_allowed fact based on user input
  set_fact:
    formatting_allowed: "{{ allow_formatting_user_input.user_input | lower == 'y' }}"

# Do overwrite
- name: Ask user for overwriting permission
  when: formatting_allowed
  changed_when: false
  block:
    - name: Send request
      pause:
        prompt: "WARNING: DATA LOSS.\n Do you want to overwrite the disks before formatting (y/n)?"
      register: do_overwrite_user_input

    - name: Set do_overwrite fact based on user input
      set_fact:
        do_overwrite: "{{ do_overwrite_user_input.user_input | lower == 'y' }}"

- name: Overwriting disks
  when: do_overwrite and formatting_allowed
  block:
    - name: Overwriting the disks with /dev/zero
      command: dd if=/dev/zero of=/dev/{{ item.device }} bs=1M status=progress
      loop: "{{ disk_mapping }}"
      when: item.wwn in disk_mapping | map(attribute='wwn') | list
      register: overwrite_results
      changed_when: false

    - name: Display overwriting results
      debug:
        var: overwrite_results

- name: Create ZFS pools (RAID-Z)
  when: formatting_allowed
  block:
    - name: Create keyfile directory
      file:
        path: "/etc/zfs_keys"
        state: directory
        mode: "0600"

    - name: Create keyfile
      copy:
        dest: "/etc/zfs_keys/keyfile"
        content: "{{ zfs_encryption_key }}"
        owner: root
        group: root
        mode: "0600"

    - name: Get zpool status
      command: zpool status
      register: zpool_status
      changed_when: false

    - name: Create ZFS pools
      command: >-
        zpool create
        -o compression=lz4
        -o ashift={{ '12' if item.type == 'hdd' else '9' }}
        -o recordsize={{ '1M' if 'media' in item.name else '128K' }}
        -o acltype=posixacl
        -o dnodesize=auto
        -o relatime=on
        -o mountpoint=none
        -o encryption=aes-256-gcm
        -o keylocation=file:///etc/zfs_keys/keyfile
        -o keyformat=raw
        {{ item.name }}
        {{ 'raidz' if item.name == 'naspool' else '' }}
        {{ item.wwn }}
      loop: "{{ disk_config }}"
      when: item.wwn in disk_mapping | map(attribute='wwn') | list
      changed_when: zpool_status.stdout | length > 20

    - name: Create mount points
      file:
        path: "{{ item.mountpoint }}"
        state: directory
        mode: "0755"
      loop: "{{ disk_config }}"

    - name: Create ZFS datasets and mount them
      community.general.zfs:
        name: "{{ item.name }}/{{ item.name }}_data"
        extra_zfs_properties:
          mountpoint: "{{ item.mountpoint }}"
        state: present
      loop: "{{ disk_config }}"
      when: item.wwn in disk_mapping | map(attribute='wwn') | list

    - name: Get zpool status
      command: zpool status
      register: zpool_status
      changed_when: false

    - name: Show zpool status
      debug:
        var: zpool_status

# Formatting cancelled
- name: Display formatting not proceeding
  debug:
    msg: "No disks will be formatted."
  when: not formatting_allowed
